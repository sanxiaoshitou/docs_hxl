## SQL 语法场景二

### 一、WITH ROLLUP 进行分组统计
场景：查询部门薪资，并且计算总计
```mysql
 SELECT
     department,
     COUNT(*) as employee_count,
     SUM(salary) as total_salary
 FROM employees
 GROUP BY department WITH ROLLUP;
```
### 二、CASE WHEN 进行条件统计
场景：统计用户活跃度、或各种状态数量
```mysql
-- 创建用户表
CREATE TABLE users
(
    id     INT PRIMARY KEY COMMENT '用户ID',
    name   VARCHAR(50) COMMENT '用户名',
    status VARCHAR(20) COMMENT '用户状态'
) COMMENT ='用户信息表';

-- 插入测试数据
INSERT INTO users
VALUES (1, '张三', 'active'),
       (2, '李四', 'active'),
       (3, '王五', 'inactive'),
       (4, '赵六', 'active'),
       (5, '钱七', 'inactive');

-- 统计活跃和非活跃用户数量
SELECT
    SUM(CASE WHEN status = 'active' THEN 1 ELSE 0 END)   as active_users,
    SUM(CASE WHEN status = 'inactive' THEN 1 ELSE 0 END) as inactive_users
FROM users;
```

### 三、INSERT IGNORE 避免重复插入 
```mysql
INSERT IGNORE INTO users (id, name, email)
VALUES
(1, '张三', 'zhangsan@example.com'),
(3, '王五', 'wangwu@example.com');
```

### 四、ON DUPLICATE KEY UPDATE 实现插入或更新
```mysql
INSERT INTO users (id, name, email) 
VALUES 
(1, '张三', 'zhangsan_new@example.com'),
(4, '赵六', 'zhaoliu@example.com')
ON DUPLICATE KEY UPDATE name = VALUES(name),email = VALUES(email);
```

### 五、FIND_IN_SET 进行集合查询
场景：查询某个分类下的所有商品，如果分类 ID 是以逗号分隔的字符串
```mysql
-- 插入测试数据
INSERT INTO products VALUES 
(1, '商品A', '1,2,3'),
(2, '商品B', '2,3,4'),
(3, '商品C', '1,4'),
(4, '商品D', '3,4,5'),
(5, '商品E', '1,5,6');

-- 查询指定分类下的所有商品
SELECT * FROM products 
WHERE FIND_IN_SET('1', category_ids);
```

### 六、GROUP_CONCAT 合并多行数据
场景：显示每个部门的所有员工名单
```mysql
SELECT 
    department,
    GROUP_CONCAT(name SEPARATOR ', ') as employees
FROM employees
GROUP BY department;
```

### 七、使用 EXISTS 优化子查询
场景：优化查询性能。比如要找出所有包含高价商品的订单
```mysql
SELECT * FROM orders o
WHERE EXISTS (
SELECT 1 FROM order_items oi
WHERE oi.order_id = o.id
AND oi.price > 100
);
```

### 八、ROW_NUMBER() 实现分页
```mysql
SELECT * FROM (
    SELECT 
        *,
        ROW_NUMBER() OVER (ORDER BY created_at DESC) as row_num
    FROM articles
) t
WHERE row_num BETWEEN 1 AND 10;
```

### 九、WITH 子句优化复杂查询
场景：统计用户订单情况，可以先把统计数据算出来，然后再和其他表关联
```mysql
WITH user_stats AS (
    SELECT 
        user_id,
        COUNT(*) as order_count,
        SUM(amount) as total_amount
    FROM orders
    GROUP BY user_id
)
SELECT 
    u.name,
    us.order_count,
    us.total_amount
FROM users u
JOIN user_stats us ON u.id = us.user_id;
```
